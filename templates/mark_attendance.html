{% extends "layout.html" %}

{% block title %}Mark Attendance - FaceAttendance{% endblock %}

{% block head_extra %}
<style>
    #video-container {
        position: relative;
        width: 100%;
        max-width: 640px;
        margin: 0 auto;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    #video {
        width: 100%;
        height: auto;
        display: block;
        transform: scaleX(-1); /* Mirror effect */
    }
    #overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }
    .status-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="text-center mb-4">
    <h2 class="text-primary"><i class="fas fa-camera me-2"></i>Mark Attendance</h2>
    <h5 class="text-muted">{{ classroom.class_name }}</h5>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div id="video-container" class="bg-dark">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="overlay"></canvas>
                    <div class="status-badge">
                        <span id="status" class="badge bg-secondary">Initializing Camera...</span>
                    </div>
                </div>
            </div>
            <div class="card-footer text-center">
                <div class="d-grid gap-2 d-md-block">
                    <button id="start-btn" class="btn btn-primary px-4"><i class="fas fa-play me-2"></i>Start</button>
                    <button id="stop-btn" class="btn btn-danger px-4" disabled><i class="fas fa-stop me-2"></i>Stop</button>
                </div>
                <div class="mt-3 d-flex justify-content-center align-items-center gap-2">
                    <label for="camera-select" class="form-label mb-0 small">Camera:</label>
                    <select id="camera-select" class="form-select form-select-sm" style="max-width:220px;"></select>
                </div>
                <div class="mt-3">
                    <p id="message" class="text-muted mb-0">Click Start to begin attendance marking.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4 justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Attendance Log (Today)</h5>
            </div>
            <div class="card-body">
                <div class="mb-3 d-flex align-items-center gap-2">
                    <span class="small text-muted">Geofence:</span>
                    <span id="geofence-status" class="badge bg-secondary">Unknown</span>
                    <span id="geofence-distance" class="small text-muted"></span>
                </div>
                <ul id="attendance-list" class="list-group list-group-flush">
                    <!-- Attendance items will be added here dynamically -->
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/face_capture.js') }}"></script>
<script>
    // Pass class_id to the JS
    const CLASS_ID = "{{ classroom.id }}";
    (function() {
        function parseVenueCoords(v) {
            if (!v) return null;
            const m = v.match(/(-?\d+\.\d+)\s*,\s*(-?\d+\.\d+)/);
            if (!m) return null;
            const r = v.toLowerCase().match(/(\d+)\s*m/);
            return {
                lat: parseFloat(m[1]),
                lng: parseFloat(m[2]),
                radius: r ? parseFloat(r[1]) : 150
            };
        }
        function computeDistanceMeters(lat1, lon1, lat2, lon2) {
            const R = 6371000.0;
            const toRad = (d) => d * Math.PI / 180;
            const dphi = toRad(lat2 - lat1);
            const dlambda = toRad(lon2 - lon1);
            const phi1 = toRad(lat1);
            const phi2 = toRad(lat2);
            const a = Math.sin(dphi/2)**2 + Math.cos(phi1)*Math.cos(phi2)*Math.sin(dlambda/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        const venue = "{{ classroom.venue|default('') }}";
        const cfg = parseVenueCoords(venue);
        const statusEl = document.getElementById('geofence-status');
        const distEl = document.getElementById('geofence-distance');
        if (cfg && navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                const d = computeDistanceMeters(pos.coords.latitude, pos.coords.longitude, cfg.lat, cfg.lng);
                distEl.textContent = `Distance: ${Math.round(d)} m â€¢ Radius: ${cfg.radius} m`;
                if (d <= cfg.radius) {
                    statusEl.textContent = 'Inside';
                    statusEl.className = 'badge bg-success';
                } else {
                    statusEl.textContent = 'Outside';
                    statusEl.className = 'badge bg-danger';
                }
            }, () => {
                statusEl.textContent = 'Location blocked';
                statusEl.className = 'badge bg-warning text-dark';
            }, { enableHighAccuracy: true, timeout: 3000 });
        } else {
            statusEl.textContent = 'Not configured';
            statusEl.className = 'badge bg-secondary';
        }
    })();
</script>
{% endblock %}
